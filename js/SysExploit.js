let questions = [];
let selectedQuestions = [];
let currentQuestionIndex = 0;
let score = 0;
let selectedAnswer = null;

// Charger les questions depuis le fichier JSON
fetch('../data/SysExploit.json')
    .then(response => response.json())
    .then(data => {
        questions = data.questions;
        selectedQuestions = selectRandomQuestions(questions, 5);
        displayQuestion();
    })
    .catch(error => {
        console.error('Erreur lors du chargement des questions:', error);
    });

// SÃ©lectionner 5 questions alÃ©atoires
function selectRandomQuestions(questionsArray, count) {
    const shuffled = [...questionsArray].sort(() => Math.random() - 0.5);
    return shuffled.slice(0, count);
}

// Afficher la question actuelle
function displayQuestion() {
    const question = selectedQuestions[currentQuestionIndex];
    const questionText = document.getElementById('questionText');
    const answersContainer = document.getElementById('answersContainer');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const nextBtn = document.getElementById('nextBtn');

    questionText.textContent = question.question;
    answersContainer.innerHTML = '';
    selectedAnswer = null;
    nextBtn.disabled = true;

    // Mise Ã  jour de la barre de progression
    const progressPercent = ((currentQuestionIndex + 1) / selectedQuestions.length) * 100;
    progressBar.style.width = progressPercent + '%';
    progressText.textContent = `Question ${currentQuestionIndex + 1}/${selectedQuestions.length}`;

    // MÃ©langer les rÃ©ponses pour que la bonne ne soit pas toujours en premier
    const shuffledAnswers = [...question.answers].sort(() => Math.random() - 0.5);

    // Afficher les rÃ©ponses
    shuffledAnswers.forEach((answer, index) => {
        const btn = document.createElement('button');
        btn.className = 'answer-btn';
        btn.textContent = answer.text;
        btn.dataset.correct = answer.correct;
        btn.dataset.index = index;

        btn.addEventListener('click', () => selectAnswer(btn));

        answersContainer.appendChild(btn);
    });
}

// SÃ©lectionner une rÃ©ponse
function selectAnswer(button) {
    if (selectedAnswer !== null) return;

    const allButtons = document.querySelectorAll('.answer-btn');
    const isCorrect = button.dataset.correct === 'true';

    allButtons.forEach(btn => {
        btn.disabled = true;
        if (btn.dataset.correct === 'true') {
            btn.classList.add('correct');
        }
    });

    if (isCorrect) {
        score++;
        button.classList.add('correct');
    } else {
        button.classList.add('incorrect');
    }

    selectedAnswer = button.dataset.index;
    document.getElementById('nextBtn').disabled = false;
}

// Passer Ã  la question suivante
document.getElementById('nextBtn').addEventListener('click', () => {
    currentQuestionIndex++;

    if (currentQuestionIndex < selectedQuestions.length) {
        displayQuestion();
    } else {
        showResults();
    }
});

// Afficher les rÃ©sultats
function showResults() {
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modalTitle');
    const modalScore = document.getElementById('modalScore');
    const modalMessage = document.getElementById('modalMessage');
    const isValidated = score >= 3;

    modalTitle.textContent = isValidated ? 'ðŸŽ‰ FÃ©licitations !' : 'ðŸ˜” Pas encore...';
    modalScore.textContent = `Score : ${score}/5`;

    // DÃ©terminer le statut Ã  envoyer au serveur
    const validationStatus = isValidated ? 'true' : 'false';

    if (isValidated) {
        modalMessage.textContent = 'Vous avez validÃ© le quiz ! Vous maÃ®trisez les bases des systÃ¨mes open source et du Green IT.';
    } else {
        modalMessage.textContent = 'Continuez Ã  apprendre sur les systÃ¨mes open source ! RÃ©essayez pour amÃ©liorer votre score.';
    }

    // *** CORRECTION : ENVOI DE LA REQUÃŠTE DANS TOUS LES CAS (true ou false) ***
    fetch('SysExploit.php', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'validated=' + validationStatus // Envoyer 'true' ou 'false'
    });
    // *** FIN DE CORRECTION ***


    modal.style.display = 'block';
}

// Retour Ã  l'index
document.getElementById('modalBtn').addEventListener('click', () => {
    window.location.href = '../index.php';
});